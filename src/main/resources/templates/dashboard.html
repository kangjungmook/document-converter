<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - Convertio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .stat-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50">
<header class="bg-white border-b border-gray-200 px-8 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <a href="/" class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg flex items-center justify-center text-white">
                ğŸ“„
            </div>
            <span class="text-2xl font-bold">Convertio</span>
        </a>
        <div class="flex items-center gap-6">
            <span id="userName" class="text-gray-700"></span>
            <button onclick="logout()" class="text-gray-600 hover:text-purple-600">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-8 py-12">
    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <div class="bg-gradient-to-r from-purple-600 to-purple-800 rounded-2xl p-8 text-white mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-purple-200" id="welcomeText">í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <div class="text-right">
                <span class="badge bg-white text-purple-700 px-4 py-2 rounded-full font-bold" id="userRole">FREE</span>
                <p class="text-sm text-purple-200 mt-2" id="planDescription">ë¬´ë£Œ í”Œëœ (10íšŒ/ì¼)</p>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ ì‚¬ìš©ëŸ‰ í†µê³„ -->
    <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="stat-card">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl">ğŸ“Š</span>
                <span class="text-2xl font-bold text-purple-600" id="todayUsage">0</span>
            </div>
            <h3 class="font-semibold text-gray-800">ì˜¤ëŠ˜ ì´ ì‚¬ìš©ëŸ‰</h3>
            <p class="text-sm text-gray-500" id="usageLimit">FREE: í•˜ë£¨ 10íšŒ</p>
            <div class="progress-bar">
                <div class="progress-fill" id="totalProgress" style="width: 0%"></div>
            </div>
        </div>

        <div class="stat-card">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl">ğŸ“…</span>
                <span class="text-2xl font-bold text-blue-600" id="monthlyUsage">0</span>
            </div>
            <h3 class="font-semibold text-gray-800">ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰</h3>
            <p class="text-sm text-gray-500">ëˆ„ì  ë³€í™˜ íšŸìˆ˜</p>
        </div>

        <div class="stat-card">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl">â°</span>
                <span class="text-2xl font-bold text-green-600" id="remainingUsage">10</span>
            </div>
            <h3 class="font-semibold text-gray-800">ë‚¨ì€ ì‚¬ìš© íšŸìˆ˜</h3>
            <p class="text-sm text-gray-500">ì˜¤ëŠ˜ ì‚¬ìš© ê°€ëŠ¥</p>
        </div>

        <div class="stat-card">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl">ğŸ’</span>
                <span class="text-2xl font-bold text-orange-600">UP</span>
            </div>
            <h3 class="font-semibold text-gray-800">í”Œëœ ì—…ê·¸ë ˆì´ë“œ</h3>
            <p class="text-sm text-gray-500">ë¬´ì œí•œìœ¼ë¡œ!</p>
        </div>
    </div>

    <!-- ê¸°ëŠ¥ë³„ ì‚¬ìš©ëŸ‰ -->
    <div class="bg-white rounded-2xl p-8 mb-8 shadow-sm">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ”§ ê¸°ëŠ¥ë³„ ì‚¬ìš© í˜„í™©</h2>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- PDF ë³‘í•© -->
            <div class="border-2 border-gray-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸ“‘</span>
                        <div>
                            <h3 class="font-bold text-gray-800">PDF ë³‘í•©</h3>
                            <p class="text-sm text-gray-500">ì—¬ëŸ¬ PDFë¥¼ í•˜ë‚˜ë¡œ</p>
                        </div>
                    </div>
                    <span class="text-2xl font-bold text-purple-600" id="pdfMergeUsage">0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="pdfMergeProgress" style="width: 0%"></div>
                </div>
            </div>

            <!-- PDF ë¶„í•  -->
            <div class="border-2 border-gray-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">âœ‚ï¸</span>
                        <div>
                            <h3 class="font-bold text-gray-800">PDF ë¶„í• </h3>
                            <p class="text-sm text-gray-500">í˜ì´ì§€ë³„ ë¶„í• </p>
                        </div>
                    </div>
                    <span class="text-2xl font-bold text-blue-600" id="pdfSplitUsage">0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="pdfSplitProgress" style="width: 0%"></div>
                </div>
            </div>

            <!-- ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ -->
            <div class="border-2 border-gray-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸ“</span>
                        <div>
                            <h3 class="font-bold text-gray-800">ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ</h3>
                            <p class="text-sm text-gray-500">í¬ê¸° ì¡°ì ˆ</p>
                        </div>
                    </div>
                    <span class="text-2xl font-bold text-green-600" id="imageResizeUsage">0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="imageResizeProgress" style="width: 0%"></div>
                </div>
            </div>

            <!-- ì´ë¯¸ì§€ ì••ì¶• -->
            <div class="border-2 border-gray-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸ’¾</span>
                        <div>
                            <h3 class="font-bold text-gray-800">ì´ë¯¸ì§€ ì••ì¶•</h3>
                            <p class="text-sm text-gray-500">ìš©ëŸ‰ ì¤„ì´ê¸°</p>
                        </div>
                    </div>
                    <span class="text-2xl font-bold text-orange-600" id="imageCompressUsage">0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="imageCompressProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- API í‚¤ ì„¹ì…˜ -->
    <div class="bg-white rounded-2xl p-8 mb-8 shadow-sm" id="apiKeySection">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”‘ API í‚¤</h2>
        <div id="apiKeyContent">
            <p class="text-gray-600">Pro í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ë©´ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <a href="/pricing" class="inline-block mt-4 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">
                í”Œëœ ì—…ê·¸ë ˆì´ë“œ
            </a>
        </div>
    </div>

    <!-- ë¹ ë¥¸ ì‹¤í–‰ -->
    <div class="bg-white rounded-2xl p-8 shadow-sm">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸš€ ë¹ ë¥¸ ì‹¤í–‰</h2>

        <div class="grid md:grid-cols-3 gap-4">
            <a href="/pdf/merge" class="p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 transition">
                <div class="text-4xl mb-3">ğŸ“‘</div>
                <h3 class="font-bold text-gray-800 mb-2">PDF ë³‘í•©</h3>
                <p class="text-sm text-gray-600">ì—¬ëŸ¬ PDFë¥¼ í•˜ë‚˜ë¡œ</p>
            </a>

            <a href="/pdf/split" class="p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 transition">
                <div class="text-4xl mb-3">âœ‚ï¸</div>
                <h3 class="font-bold text-gray-800 mb-2">PDF ë¶„í• </h3>
                <p class="text-sm text-gray-600">í˜ì´ì§€ë³„ ë¶„í• </p>
            </a>

            <a href="/image/resize" class="p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 transition">
                <div class="text-4xl mb-3">ğŸ–¼ï¸</div>
                <h3 class="font-bold text-gray-800 mb-2">ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ</h3>
                <p class="text-sm text-gray-600">í¬ê¸° ì¡°ì ˆ</p>
            </a>
        </div>
    </div>
</main>

<script>
    // ë¡œê·¸ì¸ í™•ì¸
    const user = JSON.parse(localStorage.getItem('user') || 'null');

    if (!user) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
    } else {
        // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        document.getElementById('userName').textContent = user.name + 'ë‹˜';
        document.getElementById('welcomeText').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.name}ë‹˜!`;
        document.getElementById('userRole').textContent = user.role;

        // í”Œëœë³„ ì„¤ëª…
        const planDesc = {
            'FREE': 'ë¬´ë£Œ í”Œëœ (10íšŒ/ì¼)',
            'PRO': 'PRO í”Œëœ (100íšŒ/ì¼)',
            'ENTERPRISE': 'ENTERPRISE í”Œëœ (ë¬´ì œí•œ)'
        };
        document.getElementById('planDescription').textContent = planDesc[user.role] || 'ë¬´ë£Œ í”Œëœ';

        // ì„œë²„ì—ì„œ ì‹¤ì‹œê°„ ì‚¬ìš©ëŸ‰ ê°€ì ¸ì˜¤ê¸°
        fetchUsageData();

        // PRO/ENTERPRISE ì‚¬ìš©ìë©´ API í‚¤ í‘œì‹œ
        if (user.role === 'PRO' || user.role === 'ENTERPRISE') {
            document.getElementById('apiKeyContent').innerHTML = `
                <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 mb-4">
                    <code class="text-sm text-gray-800">${user.apiKey}</code>
                </div>
                <button onclick="copyApiKey()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    ğŸ“‹ ë³µì‚¬
                </button>
            `;
        }
    }

    // ì„œë²„ì—ì„œ ì‚¬ìš©ëŸ‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchUsageData() {
        try {
            const response = await fetch(`/pdf/api/usage/${user.id}`);
            if (response.ok) {
                const data = await response.json();
                console.log('âœ… ì‚¬ìš©ëŸ‰ ë°ì´í„°:', data);
                updateUsageDisplay(data);
            } else {
                console.error('âŒ ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:', response.status);
                // ì„œë²„ ì—ëŸ¬ì‹œ localStorage ë°ì´í„° ì‚¬ìš©
                updateUsageDisplay({
                    dailyUsage: user.dailyUsage || 0,
                    monthlyUsage: user.monthlyUsage || 0,
                    pdfMergeUsage: 0,
                    pdfSplitUsage: 0,
                    imageResizeUsage: 0,
                    imageCompressUsage: 0,
                    remainingUsage: 10,
                    role: user.role
                });
            }
        } catch (error) {
            console.error('âŒ ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì—ëŸ¬:', error);
        }
    }

    // ì‚¬ìš©ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateUsageDisplay(data) {
        const limit = data.role === 'FREE' ? 10 : (data.role === 'PRO' ? 100 : 999999);
        const remaining = data.remainingUsage !== undefined ? data.remainingUsage : Math.max(0, limit - data.dailyUsage);

        // ì „ì²´ ì‚¬ìš©ëŸ‰
        document.getElementById('todayUsage').textContent = data.dailyUsage || 0;
        document.getElementById('monthlyUsage').textContent = data.monthlyUsage || 0;
        document.getElementById('remainingUsage').textContent = data.role === 'ENTERPRISE' ? 'âˆ' : remaining;
        document.getElementById('usageLimit').textContent =
            data.role === 'FREE' ? 'FREE: í•˜ë£¨ 10íšŒ' :
                data.role === 'PRO' ? 'PRO: í•˜ë£¨ 100íšŒ' : 'ENTERPRISE: ë¬´ì œí•œ';

        // ì „ì²´ ì§„í–‰ë¥ 
        const totalProgress = data.role === 'ENTERPRISE' ? 0 : Math.min(100, (data.dailyUsage / limit) * 100);
        document.getElementById('totalProgress').style.width = totalProgress + '%';

        // ê¸°ëŠ¥ë³„ ì‚¬ìš©ëŸ‰
        document.getElementById('pdfMergeUsage').textContent = data.pdfMergeUsage || 0;
        document.getElementById('pdfSplitUsage').textContent = data.pdfSplitUsage || 0;
        document.getElementById('imageResizeUsage').textContent = data.imageResizeUsage || 0;
        document.getElementById('imageCompressUsage').textContent = data.imageCompressUsage || 0;

        // ê¸°ëŠ¥ë³„ ì§„í–‰ë¥ 
        if (data.role !== 'ENTERPRISE') {
            document.getElementById('pdfMergeProgress').style.width = Math.min(100, ((data.pdfMergeUsage || 0) / limit) * 100) + '%';
            document.getElementById('pdfSplitProgress').style.width = Math.min(100, ((data.pdfSplitUsage || 0) / limit) * 100) + '%';
            document.getElementById('imageResizeProgress').style.width = Math.min(100, ((data.imageResizeUsage || 0) / limit) * 100) + '%';
            document.getElementById('imageCompressProgress').style.width = Math.min(100, ((data.imageCompressUsage || 0) / limit) * 100) + '%';
        }
    }

    function copyApiKey() {
        navigator.clipboard.writeText(user.apiKey);
        alert('âœ… API í‚¤ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function logout() {
        localStorage.removeItem('user');
        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/';
    }

    // 5ì´ˆë§ˆë‹¤ ì‚¬ìš©ëŸ‰ ìƒˆë¡œê³ ì¹¨
    setInterval(fetchUsageData, 5000);
</script>
</body>
</html>